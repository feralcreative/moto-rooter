<!DOCTYPE html>
<html>
<head>
  <script>console.log('Inline JS: head tag parsed');</script>
  <title>JFR</title>
  <link rel="stylesheet" href="../../style/style.min.css">
  <script>
    window.initMap = function () {
      console.log('initMap called');
      const mapDiv = document.getElementById('map');
      const center = { lat: 37.665817, lng: -121.949321 };
      const map = new google.maps.Map(mapDiv, {
        center,
        zoom: 10,
        mapTypeId: 'terrain',
        mapId: 'a14091e53ca43382'
      });
      console.log('Map instance created');

      // --- Redwood Road Closure KML Layer ---
      const redwoodKmlUrl = 'data/2024-redwood-road-closure.kml';
      let redwoodPolyline = null;
      function loadRedwoodKml() {
        fetch(redwoodKmlUrl)
          .then(res => {
            if (!res.ok) throw new Error('Redwood KML fetch error ' + res.status);
            return res.text();
          })
          .then(kmlText => {
            const xmlIdx = kmlText.indexOf('<?xml');
            const cleanText = xmlIdx >= 0 ? kmlText.slice(xmlIdx) : kmlText;
            const parser = new DOMParser();
            const kmlDoc = parser.parseFromString(cleanText, 'application/xml');
            const ns = kmlDoc.documentElement.namespaceURI;
            let coordsEls = kmlDoc.getElementsByTagNameNS(ns, 'coordinates');
            if ((!coordsEls || coordsEls.length === 0)) coordsEls = kmlDoc.getElementsByTagNameNS('*', 'coordinates');
            if ((!coordsEls || coordsEls.length === 0)) coordsEls = kmlDoc.getElementsByTagName('coordinates');
            if (!coordsEls || coordsEls.length === 0) {
              console.error('No <coordinates> elements found in Redwood KML', kmlDoc);
              return;
            }
            let maxCount = 0;
            let coordEl = coordsEls[0];
            Array.from(coordsEls).forEach(el => {
              const count = el.textContent.trim().split(/\s+/).length;
              if (count > maxCount) {
                maxCount = count;
                coordEl = el;
              }
            });
            const coordText = coordEl.textContent.trim();
            const path = coordText.split(/\s+/).map(pair => {
              const [lng, lat] = pair.split(',').map(Number);
              return { lat, lng };
            }).filter(pt => !isNaN(pt.lat) && !isNaN(pt.lng));
            console.log('[Redwood] Parsed path:', path);
            if (!path.length) {
              console.error('[Redwood] No valid path points parsed!');
              return;
            }
            if (redwoodPolyline) redwoodPolyline.setMap(null);
            function safeGetRedwoodCheckbox() {
              return document.getElementById('toggle-redwood-road');
            }
            function isRedwoodChecked() {
              const cb = safeGetRedwoodCheckbox();
              return cb ? cb.checked : true; // default to true if not found
            }
            redwoodPolyline = new google.maps.Polyline({
              path,
              strokeColor: '#F00', // bright red
              strokeOpacity: 0.9,     // 50% opacity
              strokeWeight: 15,
              map: isRedwoodChecked() ? map : null,
              zIndex: 1
            });
          })
          .catch(err => console.error('Failed to load Redwood KML:', err));
      }
      // Initial load (only after controls exist)
      loadRedwoodKml();
      // Checkbox toggle logic
      const redwoodCb = document.getElementById('toggle-redwood-road');
      if (redwoodCb) {
        redwoodCb.addEventListener('change', function (e) {
          if (redwoodPolyline) {
            redwoodPolyline.setMap(this.checked ? map : null);
          } else if (this.checked) {
            loadRedwoodKml();
          }
        });
      }

      // --- Oakland Route KML Layer ---
      const oaklandKmlUrl = 'data/2025-05-18-oak-to-jfreb.kml';
      let oaklandPolyline = null;
      function loadOaklandKml() {
        fetch(oaklandKmlUrl)
          .then(res => {
            if (!res.ok) throw new Error('Oakland KML fetch error ' + res.status);
            return res.text();
          })
          .then(kmlText => {
            const xmlIdx = kmlText.indexOf('<?xml');
            const cleanText = xmlIdx >= 0 ? kmlText.slice(xmlIdx) : kmlText;
            const parser = new DOMParser();
            const kmlDoc = parser.parseFromString(cleanText, 'application/xml');
            const ns = kmlDoc.documentElement.namespaceURI;
            let coordsEls = kmlDoc.getElementsByTagNameNS(ns, 'coordinates');
            if ((!coordsEls || coordsEls.length === 0)) coordsEls = kmlDoc.getElementsByTagNameNS('*', 'coordinates');
            if ((!coordsEls || coordsEls.length === 0)) coordsEls = kmlDoc.getElementsByTagName('coordinates');
            if (!coordsEls || coordsEls.length === 0) {
              console.error('No <coordinates> elements found in Oakland KML', kmlDoc);
              return;
            }
            let maxCount = 0;
            let coordEl = coordsEls[0];
            Array.from(coordsEls).forEach(el => {
              const count = el.textContent.trim().split(/\s+/).length;
              if (count > maxCount) {
                maxCount = count;
                coordEl = el;
              }
            });
            const coordText = coordEl.textContent.trim();
            const path = coordText.split(/\s+/).map(pair => {
              const [lng, lat] = pair.split(',').map(Number);
              return { lat, lng };
            }).filter(pt => !isNaN(pt.lat) && !isNaN(pt.lng));
            console.log('[OaklandRoute] Parsed path:', path);
            if (!path.length) {
              console.error('[OaklandRoute] No valid path points parsed!');
              return;
            }
            if (oaklandPolyline) oaklandPolyline.setMap(null);
            function safeGetOaklandCheckbox() {
              return document.getElementById('toggle-oakland-route');
            }
            function isOaklandChecked() {
              const cb = safeGetOaklandCheckbox();
              return cb ? cb.checked : true;
            }
            oaklandPolyline = new google.maps.Polyline({
              path,
              strokeColor: 'orange', // yellow
              strokeOpacity: 1,
              strokeWeight: 3,
              map: isOaklandChecked() ? map : null,
              zIndex: 2
            });
          })
          .catch(err => console.error('Failed to load Oakland KML:', err));
      }
      function isOaklandChecked() {
        const cb = document.getElementById('toggle-oakland-route');
        return cb ? cb.checked : true;
      }
      loadOaklandKml();
      // Checkbox toggle logic for Oakland route
      const oaklandCb = document.getElementById('toggle-oakland-route');
      if (oaklandCb) {
        oaklandCb.addEventListener('change', function (e) {
          if (oaklandPolyline) {
            oaklandPolyline.setMap(this.checked ? map : null);
          } else if (this.checked) {
            loadOaklandKml();
          }
        });
      }

      // --- Main Route KML (drawn after Redwood for stacking) ---
      const kmlUrl = 'data/2025-05-18-jfreb.kml';
      fetch(kmlUrl)
        .then(res => {
          console.log('KML fetch status:', res.status, 'Content-Type:', res.headers.get('Content-Type'));
          if (!res.ok) {
            console.error('Failed to fetch KML file:', res.statusText);
            throw new Error('KML fetch error ' + res.status);
          }
          return res.text();
        })
        .then(kmlText => {
          console.log('Raw KML length:', kmlText.length);
          // Strip leading junk before XML prolog
          const xmlIdx = kmlText.indexOf('<?xml');
          const cleanText = xmlIdx >= 0 ? kmlText.slice(xmlIdx) : kmlText;
          console.log('Cleaned KML starts with:', cleanText.substr(0, 40));
          const parser = new DOMParser();
          const kmlDoc = parser.parseFromString(cleanText, 'application/xml');
          console.log('Root element:', kmlDoc.documentElement.localName, 'namespaceURI:', kmlDoc.documentElement.namespaceURI);
          const ns = kmlDoc.documentElement.namespaceURI;
          const exactEls = kmlDoc.getElementsByTagNameNS(ns, 'coordinates');
          console.log('getElementsByTagNameNS(ns):', exactEls.length);
          const wildEls = kmlDoc.getElementsByTagNameNS('*', 'coordinates');
          console.log('getElementsByTagNameNS(*):', wildEls.length);
          const tagEls = kmlDoc.getElementsByTagName('coordinates');
          console.log('getElementsByTagName:', tagEls.length);
          const coordsEls = exactEls.length ? exactEls : wildEls.length ? wildEls : tagEls;
          if (!coordsEls || coordsEls.length === 0) {
            console.error('No <coordinates> elements found in KML via any retrieval', kmlDoc);
            return;
          }
          console.log('Using coordsEls with length:', coordsEls.length);
          // Pick element with most coordinate pairs
          let maxCount = 0;
          let coordEl = coordsEls[0];
          Array.from(coordsEls).forEach(el => {
            const count = el.textContent.trim().split(/\s+/).length;
            if (count > maxCount) {
              maxCount = count;
              coordEl = el;
            }
          });
          console.log('Selected <coordinates> under', coordEl.parentNode.localName, 'with', maxCount, 'points');
          const coordText = coordEl.textContent.trim();
          const path = coordText.split(/\s+/).map(pair => {
            const [lng, lat] = pair.split(',').map(Number);
            return { lat, lng };
          }).filter(pt => !isNaN(pt.lat) && !isNaN(pt.lng));
          console.log('[MainRoute] Parsed path:', path);
          if (!path.length) {
            console.error('[MainRoute] No valid path points parsed!');
            return;
          }
          // Draw main route as blue polyline, above Redwood
          const mainRoutePolyline = new google.maps.Polyline({
            path,
            strokeColor: '#1976D2',
            strokeOpacity: 1,
            strokeWeight: 3, // thinner line
            map,
            zIndex: 2
          });
          window.routePath = path;
          console.log('[MainRoute] Parsed path:', path);
          if (path.length) {
            const bounds = new google.maps.LatLngBounds();
            path.forEach(point => bounds.extend(point));
            map.fitBounds(bounds);
          } else {
            console.error('[MainRoute] No valid path points parsed!');
          }
          // Add KML waypoints as markers (first/last markers 150% size)
          const placemarks = kmlDoc.getElementsByTagNameNS(ns, 'Placemark');
          const allPMs = Array.from(placemarks);
          const pointPMs = allPMs.filter(pm => pm.getElementsByTagNameNS(ns, 'Point').length > 0);
          console.log('Found Placemarks with Point:', pointPMs.length);
          pointPMs.forEach((pm, i) => {
            const pointEl = pm.getElementsByTagNameNS(ns, 'Point')[0]; if (!pointEl) return;
            const coordsEl = pointEl.getElementsByTagNameNS(ns, 'coordinates')[0]; if (!coordsEl) return;
            const [lng, lat] = coordsEl.textContent.trim().split(',').map(Number);
            const nameEl = pm.getElementsByTagNameNS(ns, 'name')[0]; const name = nameEl ? nameEl.textContent : '';
            const descEl = pm.getElementsByTagNameNS(ns, 'description')[0]; const desc = descEl ? descEl.textContent : '';
            // Icon: circle for start and intermediates, X shape for ending point
            let iconOpts;
            if (i === pointPMs.length - 1) {
              // Draw blue X (outline, bottom)
              new google.maps.Marker({
                position: { lat, lng },
                map,
                icon: {
                  path: 'M -0.7,-0.7 L 0.7,0.7 M 0.7,-0.7 L -0.7,0.7',
                  strokeColor: '#1976D2',
                  strokeWeight: 4,
                  scale: 8,
                  strokeOpacity: 1
                },
                clickable: false,
                zIndex: 999
              });
              // Draw black X (center, top)
              iconOpts = {
                path: 'M -0.7,-0.7 L 0.7,0.7 M 0.7,-0.7 L -0.7,0.7',
                strokeColor: '#000000',
                strokeWeight: 6,
                scale: 8,
                strokeOpacity: 1
              };
            } else {
              // Blue circle for start and others (start scaled 6)
              iconOpts = {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#1976D2',
                fillOpacity: 0.9,
                strokeColor: '#1976D2',
                strokeWeight: 1,
                scale: (i === 0 ? 6 : 4)
              };
            }
            const marker = new google.maps.Marker({ position: { lat, lng }, map, title: name, icon: iconOpts });
            const infowindow = new google.maps.InfoWindow({ content: `<strong>${name}</strong><br/>${desc}`, disableAutoPan: false, shouldFocus: false });
            google.maps.event.addListener(infowindow, 'domready', () => {
              const iw = document.querySelector('.gm-style-iw');
              if (iw) {
                const closeBtn = iw.parentElement.querySelector('button[aria-label="Close"]');
                if (closeBtn) closeBtn.style.display = 'none';
              }
            });
            let popupOpen = false;
            marker.addListener('mouseover', () => {
              if (!popupOpen) infowindow.open({ map, anchor: marker });
            });
            marker.addListener('mouseout', () => {
              if (!popupOpen) infowindow.close();
            });
            marker.addListener('click', () => {
              if (!popupOpen) {
                infowindow.open({ map, anchor: marker });
                popupOpen = true;
              } else {
                infowindow.close();
                popupOpen = false;
              }
            });
            infowindow.addListener('closeclick', () => { popupOpen = false; });
          });
        })
        .catch(err => console.error('Failed to load KML:', err));
    }
  </script>
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmn_vo6Zy65qtOH47AKdrQhP9L-j2q9mE&v=beta&libraries=maps,geometry&callback=initMap" onload="console.log('maps API loaded');" onerror="console.error('maps API failed to load');"></script>
  <style>
    /* Migrated to vmc/style/style.scss */
  </style>
</head>
<body>
  <script>console.log('Inline JS: body tag parsed, running under', location.href);</script>
  <div id="map"></div>
  <div id="map-controls" class="floating-panel">
    <div class="panel-title">Map Controls</div>
    <button class="gpx-btn" onclick="window.open('data/2025-05-18-jfreb.gpx', '_blank')">Download GPX</button>
    <button class="kml-btn" onclick="window.open('data/2025-05-18-jfreb.kml', '_blank')">Download KML</button>
    <label style="display:flex;align-items:center;gap:6px;font-size:0.95em;margin-top:8px;">
      <input type="checkbox" id="toggle-redwood-road" checked>
      Redwood Road Closure
    </label>
    <label style="display:flex;align-items:center;gap:6px;font-size:0.95em;margin-top:8px;">
      <input type="checkbox" id="toggle-oakland-route" checked>
      Route from Oakland
    </label>
  </div>
  <div id="info-panel" class="floating-panel right-panel">
    <div class="panel-title">Ride Info</div>
    <table class="info-table">
      <tr>
        <td>Meeting point:</td>
        <td>Daybreak Donuts &amp; Ice Cream</td>
      </tr>
      <tr>
        <td>KSU:</td>
        <td>10am</td>
      </tr>
    </table>
  </div>
  <script>
    console.log('Post-map script: map in DOM:', document.getElementById('map'));
  </script>
</body>
</html>